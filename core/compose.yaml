name: core

services:
  # Traefik reverse proxy
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - CLOUDFLARE_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
    ports:
      - 80:80 # HTTP
      - 443:443 # HTTPS
    volumes:
      - ${HOST_APPDATA}/traefik:/etc/traefik
      - /var/log/traefik:/var/log/traefik
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)
      - traefik.http.routers.traefik.service=api@internal
      - traefik.http.routers.traefik.tls.certresolver=cloudflare
      - traefik.http.routers.traefik.middlewares=local-ip-whitelist@file,authentik@file
      - homepage.group=Core
      - homepage.description=Reverse proxy
      - homepage.name=Traefik
      - homepage.icon=traefik
      - homepage.href=https://traefik.${DOMAIN}
      - homepage.widget.type=traefik
      - homepage.widget.url=http://traefik:7000

  # Technitium DNS server
  dns-server:
    image: technitium/dns-server:latest
    container_name: dns-server
    restart: unless-stopped
    ports:
      - 53:53/udp # DNS over UDP
      - 53:53/tcp # DNS over TCP
      - 53443:53443 # Technitium DNS web interface (secure)
    environment:
      - DNS_SERVER_DOMAIN=${DOMAIN}
    volumes:
      - ${HOST_APPDATA}/dns-server:/etc/dns
    labels:
      - traefik.enable=true
      - traefik.http.routers.dns-server.rule=Host(`dns.${DOMAIN}`)
      - traefik.http.routers.dns-server.tls.certresolver=cloudflare
      - traefik.http.services.dns-server.loadbalancer.server.port=5380
      - homepage.group=Core
      - homepage.name=Technitium DNS
      - homepage.description=DNS Cluster Management
      - homepage.icon=technitium
      - homepage.href=https://dns.${DOMAIN}
      - homepage.widget.type=technitium
      - homepage.widget.url=http://dns-server:5380
      - homepage.widget.key=${TECHNITIUM_DNS_TOKEN}
      - homepage.widget.range=LastDay
    sysctls:
      - net.ipv4.ip_local_port_range=1024 65535 # to allow high port range for DNS queries

  # PostgreSQL database service
  postgres:
    image: postgres:17
    container_name: core-postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ${HOST_APPDATA}/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 5s

  # Pocket ID
  pocket-id:
    image: ghcr.io/pocket-id/pocket-id:v2
    container_name: pocket-id
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - APP_URL=https://id.${DOMAIN}
      - TRUST_PROXY=true
      - ENCRYPTION_KEY=${POCKETID_ENCRYPTION_KEY}
      - DB_CONNECTION_STRING=postgres://pocketid:${POCKETID_DB_PASSWORD}@core-postgres/pocketid
      - MAXMIND_LICENSE_KEY=${POCKETID_MAXMIND_KEY}
    volumes:
      - ${HOST_APPDATA}/pocket-id:/app/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.pocket-id.rule=Host(`id.${DOMAIN}`)
      - traefik.http.routers.pocket-id.tls.certresolver=cloudflare
      - traefik.http.services.pocket-id.loadbalancer.server.port=1411
    healthcheck:
      test: ['CMD', '/app/pocket-id', 'healthcheck']
      interval: 1m30s
      timeout: 5s
      retries: 2
      start_period: 10s

  # Tinyauth
  tinyauth:
    image: ghcr.io/steveiliop56/tinyauth:v4
    container_name: tinyauth
    restart: unless-stopped
    environment:
      - APP_URL=https://tinyauth.${DOMAIN}
      - USERS=${TINYAUTH_USERS} # https://tinyauth.app/docs/getting-started#user-creation
      - PROVIDERS_POCKETID_CLIENT_ID=${TINYAUTH_POCKETID_CLIENT_ID}
      - PROVIDERS_POCKETID_CLIENT_SECRET=${TINYAUTH_POCKETID_CLIENT_SECRET}
      - PROVIDERS_POCKETID_AUTH_URL=https://id.${DOMAIN}/authorize
      - PROVIDERS_POCKETID_TOKEN_URL=https://id.${DOMAIN}/api/oidc/token
      - PROVIDERS_POCKETID_USER_INFO_URL=https://id.${DOMAIN}/api/oidc/userinfo
      - PROVIDERS_POCKETID_REDIRECT_URL=https://tinyauth.${DOMAIN}/api/oauth/callback/pocketid
      - PROVIDERS_POCKETID_SCOPES=openid email profile groups
      - PROVIDERS_POCKETID_NAME=Pocket ID
      - OAUTH_AUTO_REDIRECT=pocketid
      - OAUTH_WHITELIST=${TINYAUTH_OAUTH_WHITELIST} # comma-separated list of allowed email addresses
      - DOCKER_HOST=tcp://socket-proxy:2375
    volumes:
      - tinyauth-data:/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.tinyauth.rule=Host(`tinyauth.${DOMAIN}`)
      - traefik.http.routers.tinyauth.tls.certresolver=cloudflare
      - traefik.http.services.tinyauth.loadbalancer.server.port=3000
      - traefik.http.middlewares.tinyauth.forwardauth.address=http://tinyauth:3000/api/auth/traefik

  # Homepage personal dashboards
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    volumes:
      - ${HOST_APPDATA}/homepage/config:/app/config
      - ${HOST_APPDATA}/homepage/images:/app/public/images
    environment:
      - HOMEPAGE_ALLOWED_HOSTS=${DOMAIN}
      - PUID=${PUID}
      - PGID=${PGID}
    labels:
      - traefik.enable=true
      - traefik.http.routers.homepage.rule=Host(`${DOMAIN}`)
      - traefik.http.routers.homepage.tls.certresolver=cloudflare
      - traefik.http.routers.homepage.middlewares=tinyauth
      - traefik.http.services.homepage.loadbalancer.server.port=3000
      - tinyauth.apps.homepage.config.domain=${DOMAIN}
      - tinyauth.apps.homepage.oauth.groups=administrators

  # Docker socket proxy
  socket-proxy:
    image: lscr.io/linuxserver/socket-proxy:latest
    container_name: socket-proxy
    restart: unless-stopped
    environment:
      - CONTAINERS=1
      - EVENTS=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    read_only: true
    tmpfs:
      - /run

  # pgAdmin web interface for Postgres
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
    volumes:
      - ${HOST_APPDATA}/pgadmin/config/config_local.py:/pgadmin4/config_local.py:ro
      - ${HOST_APPDATA}/pgadmin/data:/var/lib/pgadmin
    labels:
      - traefik.enable=true
      - traefik.http.routers.pgadmin.rule=Host(`pgadmin.${DOMAIN}`)
      - traefik.http.routers.pgadmin.tls.certresolver=cloudflare

  # Apprise API
  apprise:
    image: caronc/apprise:latest
    container_name: apprise
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - APPRISE_STATEFUL_MODE=simple
      - APPRISE_WORKER_COUNT=1
    volumes:
      - ${HOST_APPDATA}/apprise/config:/config
      - ${HOST_APPDATA}/apprise/plugin:/plugin
      - ${HOST_APPDATA}/apprise/attach:/attach
    labels:
      - traefik.enable=true
      - traefik.http.routers.apprise.rule=Host(`apprise.${DOMAIN}`)
      - traefik.http.routers.apprise.tls.certresolver=cloudflare
      - traefik.http.services.apprise.loadbalancer.server.port=8000

  # Ntfy notification service
  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: ntfy
    restart: unless-stopped
    command: ['serve']
    environment:
      - TZ=${TZ}
      - NTFY_BASE_URL=https://ntfy.${DOMAIN}
      - NTFY_BEHIND_PROXY=true
      - NTFY_CACHE_FILE=/var/lib/ntfy/cache.db
      - NTFY_AUTH_FILE=/var/lib/ntfy/auth.db
      - NTFY_ATTACHMENT_CACHE_DIR=/var/lib/ntfy/attachments
      - NTFY_AUTH_DEFAULT_ACCESS=deny-all
      - NTFY_AUTH_USERS=${NTFY_AUTH_USERS}
      - NTFY_AUTH_ACCESS=service:*:rw
      - NTFY_ENABLE_LOGIN=true
      - NTFY_REQUIRE_LOGIN=true # all actions via the web app require a login
    user: ${PUID}:${PGID}
    volumes:
      - ${HOST_APPDATA}/ntfy:/var/lib/ntfy
    labels:
      traefik.enable: true
      traefik.http.routers.ntfy.rule: Host(`ntfy.${DOMAIN}`)
      traefik.http.routers.ntfy.tls.certresolver: cloudflare
      traefik.http.services.ntfy.loadbalancer.server.port: 80
    healthcheck: # optional: remember to adapt the host:port to your environment
      test:
        - 'CMD-SHELL'
        - "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1"
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
    init: true # needed, if healthcheck is used. Prevents zombie processes

volumes:
  tinyauth-data:
    name: tinyauth-data

networks:
  default:
    name: core
    driver: bridge
